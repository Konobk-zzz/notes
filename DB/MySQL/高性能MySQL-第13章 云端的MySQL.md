# 第13章 云端的MySQL

可以粗略的将其分为两类：

- IaaS(基础设施既服务)

  Iaas是用于托管自有的Mysql服务器的云端基础架构。可以根据需求随意配置Mysql和操作系统，但也没有权限也无法看到处于底层的物理硬件设备。

- DBaaS(数据库既服务)

  Mysql本身作为由云端管理的资源。可以配置一些Mysql的选项，但没有权限去控制或查看底层的操作系统或虚拟服务器实例。

## 13.1 云的优点、缺点和相关误解

- 云是一种将基础设施外包出去无须自己管理的方法。你不需要寻找供应商购买硬件，也不需要维护和供应商之间的关系，更无须替换失效的硬盘驱动器等。
- 云一般是按照即用即付的方式支付，可以把前期的大量资本支出转换为持续的运营成本。
- 随着供应商发布行的服务和成本降低，云提供的价值越来越大。你自己无须做任何事情（如升级服务器），就可以从这些提升中获益；随着时间推移你会很容易地获得更多更好的选择并且费用更低。
- 云能帮助你轻松地准备好服务器和其他资源，在用完后直接将其关闭，而无须关注怎么处理他们，或者怎么卖掉它们收回成本。
- 云代表了对基础设施的另一种思考方式——作为通过API来定义和控制的资源——支持更多的自动化操作。从“私有云”中也可以获得这些好处。

缺点：

- 资源是共享且不可预测的，实际上你可以获得比你支付的更多的资源。这听起来很不错，但却导致容量规划很难做。如果你在不知情的情况下获得了比理应享受到的更多的计算资源，那么就存在这一的风险：别人也许会索要他们应得的资源，这会使你的应用性能退化到应有的水平。
- 无法保证容量和可用性。
- 虚拟的共享资源导致排查故障更加困难，特别是在无法访问底层物理硬件的情况下无法检查并弄清楚到底发生了什么。

误解：

- 云天生具备更好的可扩展性

  应用、云的架构，以及管理云服务的组织是不是都是可以扩展的。选择一个可扩展的平台并不能自动使应用变得可扩展。在需要时能够获得资源仅仅是扩展性的一个方面而已。

- 云可以自动改善甚至保证可用时间

  一般来说每个别在云端脱光的服务器比那些经过良好设计的专用基础设施更容易发生故障或运行中段。

- 云是唯一能够提供【？？？随便你想到的优点】的东西

- 云是一个“银弹”

## 13.2 MySQL在云端的经济价值

在一些场景下云托管比传统的服务器部署方式更经济。以我们的经验来看，云脱光比较适合尚处于初级阶段的企业，或者那些持续接触新概念并且本质上是以适用为主的企业，例如移动应用开发者或游戏开发者。

云的临一中潜在的大用于是运行不是很重要的基础设施，例如集成环境、开发测试平台，以及评估环境。

## 13.3 云中的MySQL的可扩展性和高可用性

正如我们之前提到的，Mysql并不会在云端变得更具扩展性。事实上，如果机器的性能较差，会导致过早使用横向扩展策略。况且云托管相比专用的硬件可靠性和可预测性要更差一些，所以想在云端获得高可用性需要更多的创新。

云另外一个迷惑人的地方是梦想中的自动扩展——就是根据需求的增加或减少来启动或关闭实例。尽管对诸如Web服务器这样的无状态部分是可行的，但对于数据库服务器而言则很难做到，因为它是有状态的。对于一些特定的场景例如以读为主的应用，可以通过增加备库的方式来获得有限的自动扩展，但这并不是一个通用的解决方案。实际上，虽然许多应用在Web层使用了自动扩展，但Mysql并不具备在一个无共享（Shared Nothing）集群中的对等角色服务器之间迁移的能力。你可以通过分片架构来从新分片并自动增长或搜索，但Mysql本身是无法自动扩展的。

## 13.4 四种基础资源

MySQL需要四种基础资源来完成工作：CPU周期、内存、I/O，以及网络。这四种资源的特性和重要程度在不同的云平台上是各不相同的。

- CPU通常很少且慢
- 内存大小受限制
- I/O的吞吐量、延迟以及一致性受到限制
- 尽管网络通常是一个变化多端的共享资源，但是性能通常比较好。

## 13.5 MySQL在云主机上的性能

- 需要高并发的工作负载并不是非常适合云计算。对于那些要求非常快的响应时间的应用同样如此。原因可以归结于虚拟CPU的数目和速度方面的限制。每个Mysql查询运行在一个单独的CPU上，所以查询响应时间实际上是由CPU的原始速度决定的。如果期望得到更快的响应时间，就需要更快的CPU。为了支持更高的并发度，你需要更多的CPU。Mysql和InnoDB不会因为运行在大量CPU核心上而提供爆炸式的改进，但目前通常能在至少24个核心上面获得比较好的横向扩展，这通常比在云中能够获得的核心数更多。
- 那些需要大量I/O的工作负载在云中并不总是表现的很好。当I/O很慢并且不稳定时，工作会很快中断。但另一方面，如果你的工作负载不需要太多的I/O，不管是吞吐量（每秒的执行量）还是带宽（每秒字节数），Mysql就可以运行的很好。

关于这些你可以做点什么呢？对于CPU的限制你做不了太多买不够就是不够。但是I/O则不同。I/O实际上是两种存储器的交换：非永久存储器（RAM）和持久化存储器（磁盘、EBS，或者其他你所拥有的）。因此MySQL的I/O需求会受系统内存大小的影响。当有足够的内存时，可以从缓存中读取数据，从而减少读和写操作的I/O。写入同样可以缓存在内存里，多个对相同内存比特位的写入可以合并成单个I/O操作。

## 13.6 MySQL数据库既服务（DBaaS）

在云端服务器上安装Mysql并不是在云中使用Mysql的唯一方法。已经有越来越多的公司开始将数据库本身作为云资源，称之为数据库即服务（DBaaS，有时候也叫Daas）,这意味着你可以在一个地方使用云中的数据库，而在另外的地方运行真正的服务。

### 13.6.1 Amazon RDS

RDS可以提供一些比较吸引人的好处，这取决于你的具体情况。

- 你可以将系统管理甚至许多数据库管理的工作留给Amazon。例如他们会为你进行复制并保证你不会把事情搞砸。
- RDS相比其他选择而言可能更便宜，这取决于你的成本结构和人力资源。
- RDS中的限制也许是件好事：Amazon拿走了那把子弹上膛的枪，防止你用它自残。

但是，他也有一些潜在的缺点。

- 由于无法控制服务器，也就无法弄清楚操作系统中到底发生了什么。例如，你无法衡量I/O响应时间和CPU利用率。
- 无法获得完整的慢查询日志文件。你可以指定Mysql将慢日志记录到一个CSV日志表中，但这并不是很好。它会消耗很多服务器资源，并且不会给出精准的查询响应时间。这使得很难去分析和排除SQL故障。
- 如果你希望得到最新最好的，或者一些性能上的增强，例如那些你可以从Percona Server上获得的提升，那就不走运了，RDS并不提供这些。
- 你必须依赖Amazon的支持团队来解决一些问题，而这些问题可能本来是你自己可以解决的。例如，假设查询挂起了，或者服务器由于数据损坏崩溃了。你既可以等待Amazon来解决，也可以自己解决。如果是后者你就需要把数据转移到别的地方。你无法通过访问实例本身来解决。