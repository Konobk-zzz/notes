# 第2章 MySQL基准测试

基准测试（benchmark）是MySQL新手和专家都需要掌握的一项基本技能。简单的来说，基准测试是针对系统设计的一种压力测试。通常的目的是为了掌握系统的行为。但也有其他原因，如重现某个系统状态，或者是做新硬件的可靠性测试。

## 2.1 为什么需要基准测试

- 验证基于系统的一些假设，确认这些假设是否符合实际情况。
- 重现系统中的某些异常行为，以解决这些一场。
- 测试系统当前的运行情况。
- 模拟比当前系统更高的负载，以找出系统随着压力增加而可能遇到的扩展性瓶颈。
- 规划未来的业务增长。基准测试可以评估在项目未来的负载下，需要什么样的硬件，需要多大容量的网络，以及其他相关资源。这有助于降低系统升级和重大变更的风险。
- 测试应用适应可变环境的能力。
- 测试不同的硬件、软件和操作系统配置。
- 证明新采购的设备是否配置正确。

基准测试要尽量简单直接，结果之间容易相互比较，成本低且易于执行。

## 2.2 基准测试的策略

基准测试有两种主要的策略：一是针对整个系统的整体测试，另外是单独测试MySQL。这两种策略也被称为集成式（full-stack）以及单组件式（single-component）基准测试。针对整个系统做集成式测试，而不是单独测试Mysql的原因主要有一下几点：

- 测试整个应用系统，包括Web服务器、应用代码、网络和数据库是非常有用的，因为用户关注的并不仅仅是Mysql本身的性能，而是应用整体的性能。
- Mysql并非总是应用的瓶颈，通过整体的测试可以揭示这一点。
- 只有对应用做整体测试，才能发现各部分之间的缓存带来的影响。
- 整体应用的集成式测试更能揭示应用的真实表现，而单独组件的测试很难做到这一点。

另一方面，应用的整体基准测试很难建立，甚至很难正确设置。如果基准测试的设计有问题，那么结果就无法反映真实的情，从而基于此做的决策也就可能是错误的。

不过，有时候不需要了解整个应用的情况，而只需要关注Mysql的性能，至少在项目初期可以这样做。基于一下情况，可以选择只测试Mysql：

- 需要比较不同的schema或查询的性能。
- 针对应用中某个具体问题的测试。
- 为了避免漫长的基准测试，可以通过一个短期的基准测试，做快速的“周期循环”，来检测出某些调整后的效果。

另外，如果能够在真实的数据集上执行重复的查询，那么针对Mysql的基准测试也是有用的，但是数据本身和数据集的大小都应该是真实的。如果可能，可以采用生产环境的数据快照。

### 2.2.1 测试何种指标

- 吞吐量

  吞吐量指的是单位时间内的事务处理数。

- 响应时间或延迟

  这个指标用于测试任务所需的整体时间。

- 并发性

  Web服务器的并发性更准确的度量指标，应该是在任意时间有多少同时发生的并发请求。

- 可扩展性

  在系统的业务压力可能发生变化的情况下，测试可扩展性就非常必要了。可扩展性指的是，给系统增加一倍的工作，在理想情况下就能或测两倍的效果（即吞吐量增加一倍）。或者说，给系统增加一倍的资源（比如两倍的CPU数），就可以获得两倍的吞吐量。

## 2.3 基准测试方法

如何避免一些常见错误：

- 使用真实数据的子集而不是全集。例如应用需要处理几百DB的数据，但测试只有1GB数据；或者只是用当前数据进行测试，却希望模拟未来业务大幅度增长后的情况。
- 使用错误的数据分布。例如使用均匀分布的数据测试，而系统的真实数据有很多热点区域（随机生成的测试数据通常无法模拟真实的数据分布）。
- 使用不真实的分布参数，例如假定所有用户的个人信息（profile）都会被平均的读取。
- 在多用户场景中，值做单用户测试。
- 在单服务器上测试分布式应用。
- 与真实用户行为不匹配。
- 反复执行同一个查询。
- 没有检查错误。
- 忽略了系统预热（warm up）的过程。
- 使用默认的服务器配置。
- 测试时间太短。基准测试现需要持续一定的时间。

### 2.3.1设计和规划基准测试

规划基准测试的第一步是提出问题并明确目标。然后决定是采用标准的基准测试，还是设计专用的测试。

### 2.3.2 基准测试应该运行多长时间

基准测试应该运行足够长的时间，如果无法确认测试需要运行多长的时间才足够，可以让测试一直运行，持续观察知道确认系统已经稳定。而如果系统有大量的数据和内存，要达到稳定状态可能需要非常长时间。大部分系统都会有一些应对突发情况的余量，能够吸收性能尖峰，将一些工作延迟到高峰期之后执行。但当对机器加压足够长时间之后，这些余量会被消耗尽，系统的短期尖峰也就无法维持原来的高性能。

### 2.3.3 获取系统性能和状态

在执行基准测试时，需要尽可能多地手机被测试系统的信息。最好为基准测试建立一个目录，并且每执行一轮测试都创建单独的子目录，将测试结果、配置文件、测试指标、脚本和其他相关说明都保存在其中。需要记录的数据包括系统状态和性能指标，诸如CPU使用率、磁盘I/O、网络流量统计、SHOW GLOBAL STATUS 计数器等。

### 2.3.4 获得准确的测试结果、

获得准确测试结果的最好办法，是回答一些关于基准测试的基本问题：是否选择了正确的基准测试？是否为问题收集了相关数据？是否采用了错误的测试标准？例如，是否对一个I/O密集型应用，采用了CPU密集型的测试标准来评估性能？

接着，确认测试结果过是否可重复。每次重新测试之前要确保系统的状态是一致的。

每次测试中，修改的参数应该尽量少。如果必须要一次修改多个参数，那么可能会丢失一些信息。有些参数以来其他参数，这些参数可能无法单独修改。有时候甚至都没有意识到这些依赖，这给测试带来了复杂性。

一般情况下，都是通过迭代逐步的修改基准测试的参数，而不是每次运行时都做大量的修改。

### 2.3.5 运行基准测试并分析结果

通常来说，自动化基准测试是个好主意。这样做可以获得更精确的测试结果。因为自动化的过程可以防止测试人员偶尔一楼某些步骤，或者误操作。另外也有助于归档整个测试过程。

### 2.3.6绘图的重要性

最简单有效的图形，就是将性能指标按照时间顺序绘制。通过图形可以立刻发现一些问题，而这些问题在原始数据中很难被注意到。

## 2.4 基准测试工具

略 P49

## 2.5 基准测试案例

略 P52

